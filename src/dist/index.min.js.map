{"version":3,"sources":["index.ts"],"names":["core","require","rest_1","utils_1","auth_action_1","checkWorkflow","token","owner","repo","statusToCheck","currentRunId","runnerLabel","Promise","foundRunningJob","createActionAuth","auth","authentication","_c","sent","info","tokenType","octokit","Octokit","baseUrl","actions","listWorkflowRunsForRepo","rest","status","listWorkflowRunsForRepoResult","data","total_count","workFlowRunsFiltered","workflow_runs","filter","f","id","Number","workFlowRunsMapped","map","x","run_id","name","workFlowRunsMapped_1","_i","length","workFlowRun","listJobsForWorkflowRun","listJobsForWorkflowRunResult","_a","_b","jobs","labels","includes","run","getInput","required","undefined","fullRepo","getOptionalInput","getRepository","getOwnerAndRepo","statusesToCheck_1","setOutput","setFailed","ex_1"],"mappings":"y7CAAA,IAAAA,KAAAC,QAAA,iBAEAC,OAAAD,QAAA,iBACAE,QAAAF,QAAA,WAKAG,cAAAH,QAAA,wBAEA,SAAeI,cAAcC,EAAeC,EAAeC,EAAcC,EAAgEC,EAAsBC,gCAAsBC,QAAO,kGAKnK,OAJnBC,GAAkB,EAIC,CAAA,EADVT,cAAAU,kBACgBC,WAOS,OAPhCC,EAAiBC,EAAAC,OAEvBlB,KAAKmB,KAAK,mBAAmBH,EAAeI,UAAS,WAAWb,EAAK,UAAUC,IAEzEa,EAAU,IAAInB,OAAAoB,QAAQ,CAAEC,QAAS,yBAA0BR,KAAMC,EAAeV,SAE9EkB,QAAQC,0BACsB,CAAA,EAAMJ,EAAQK,KAAKF,QAAQC,wBAAwB,CACvFlB,MAAOA,EACPC,KAAMA,EACNmB,OAAQlB,YAHJmB,EAAgCX,EAAAC,OAMtClB,KAAKmB,KAAK,yBAAyBS,EAA8BD,OAAM,wBAAwBC,EAA8BC,KAAKC,aAE9HC,EAAuBH,EAA8BC,KAAKG,cAAcC,OAAO,SAACC,GAAM,OAAAA,EAAEC,IAAMC,OAAO1B,KAEnG2B,EAAqBN,EAAqBO,IAAI,SAACC,GAAM,MAAA,CACzDC,OAAQD,EAAEJ,GACVM,KAAMF,EAAEE,YAGgBC,EAAAL,0BAAAM,EAAAD,EAAAE,QAAfC,EAAWH,EAAAC,GACiB,CAAA,EAAMtB,EAAQK,KAAKF,QACrDsB,uBAAuB,CACtBvC,MAAKA,EACLC,KAAIA,EACJgC,OAAQK,EAAYL,WALkB,CAAA,EAAA,UAU1C,IATMO,EAA+B9B,EAAAC,OAOrClB,KAAKmB,KAAK,yBAAyB4B,EAA6BpB,OAAM,wBAAwBoB,EAA6BlB,KAAKC,aAEhIkB,EAAA,EAAkBC,EAAAF,EAA6BlB,KAAKqB,KAAlCF,EAAAC,EAAAL,OAAAI,IAChB,GADYC,EAAAD,GACJG,OAAOC,SAASzC,GAAc,CACpCE,GAAkB,EAClB,MAGJ,GAAIA,EACF,MAAA,CAAA,EAAA,2BAjBsB8B,iBAuB1B,OAFA3C,KAAKmB,KAAK,8BAA8BV,EAAa,KAAKI,GAE1D,CAAA,EAAOA,QAGT,SAAewC,mCAAOzC,QAAO,wHAEnBN,EAAQN,KAAKsD,SAAS,QAAS,CAAEC,UAAU,IAC3C7C,EAAeV,KAAKsD,SAAS,eAAgB,CAAEC,UAAU,IACzD5C,EAAcX,KAAKsD,SAAS,cAAe,CAAEC,UAAU,SAE5CC,KADbC,EAAWtD,QAAAuD,iBAAiB,WAE9BD,EAAWtD,QAAAwD,iBAEPX,EAAgB7C,QAAAyD,gBAAgBH,GAA/BlD,EAAKyC,EAAA,GAAExC,EAAIwC,EAAA,GAElBhD,KAAKmB,KAAK,cAAcsC,EAAQ,WAAWlD,EAAK,UAAUC,GAE1DR,KAAKmB,KAAK,wDAAwDR,EAAW,kCAAkCD,GAG3GG,GAAkB,MAIMgD,EAD6C,CAAC,YAAa,SAAU,cAAe,mCACpFlB,EAAAkB,EAAAjB,QAAjBnC,EAAaoD,EAAAlB,GACJ,CAAA,EAAMtC,cAAcC,EAAOC,EAAOC,EAAMC,EAAeC,EAAcC,KAD9C,CAAA,EAAA,UAEzC,GADAE,EAAkBoC,EAAA/B,OAEhB,MAAA,CAAA,EAAA,2BAHwByB,wBAO5B3C,KAAKmB,KAAK,oBAAoBN,GAC9Bb,KAAK8D,UAAU,kBAAmBjD,kCAGlCb,KAAK+D,UAAU,sBAAsBC,+BAIzCX","file":"index.min.js","sourcesContent":["import * as core from '@actions/core';\r\nimport { components } from \"@octokit/openapi-types\";\r\nimport { Octokit } from '@octokit/rest';\r\nimport {\r\n  getOptionalInput,\r\n  getOwnerAndRepo,\r\n  getRepository\r\n} from './utils';\r\nimport { createActionAuth } from \"@octokit/auth-action\";\r\n\r\nasync function checkWorkflow(token: string, owner: string, repo: string, statusToCheck: components[\"parameters\"][\"workflow-run-status\"], currentRunId: string, runnerLabel: string): Promise<boolean> {\r\n  let foundRunningJob = false;\r\n\r\n\r\n  const auth = createActionAuth();\r\n  const authentication = await auth();\r\n\r\n  core.info(`Auth token type ${authentication.tokenType}, owner ${owner}, repo ${repo}`);\r\n\r\n  const octokit = new Octokit({ baseUrl: 'https://api.github.com', auth: authentication.token });\r\n\r\n  octokit.actions.listWorkflowRunsForRepo()\r\n  const listWorkflowRunsForRepoResult = await octokit.rest.actions.listWorkflowRunsForRepo({\r\n    owner: owner,\r\n    repo: repo,\r\n    status: statusToCheck\r\n  });\r\n\r\n  core.info(`Received status code: ${listWorkflowRunsForRepoResult.status}, number or results: ${listWorkflowRunsForRepoResult.data.total_count}`);\r\n\r\n  let workFlowRunsFiltered = listWorkflowRunsForRepoResult.data.workflow_runs.filter((f) => f.id != Number(currentRunId));\r\n\r\n  const workFlowRunsMapped = workFlowRunsFiltered.map((x) => ({\r\n    run_id: x.id,\r\n    name: x.name\r\n  }));\r\n\r\n  for (const workFlowRun of workFlowRunsMapped) {\r\n    const listJobsForWorkflowRunResult = await octokit.rest.actions\r\n      .listJobsForWorkflowRun({\r\n        owner,\r\n        repo,\r\n        run_id: workFlowRun.run_id\r\n      });\r\n\r\n    core.info(`Received status code: ${listJobsForWorkflowRunResult.status}, number or results: ${listJobsForWorkflowRunResult.data.total_count}`);\r\n\r\n    for (const job of listJobsForWorkflowRunResult.data.jobs) {\r\n      if (job.labels.includes(runnerLabel)) {\r\n        foundRunningJob = true;\r\n        break;\r\n      }\r\n    }\r\n    if (foundRunningJob)\r\n      break;\r\n  }\r\n\r\n  // conclusion is null when run is in progress\r\n  core.info(`foundRunningJob for status ${statusToCheck}: ${foundRunningJob}`);\r\n\r\n  return foundRunningJob;\r\n}\r\n\r\nasync function run(): Promise<void> {\r\n  try {\r\n    const token = core.getInput('token', { required: true });\r\n    const currentRunId = core.getInput('currentRunId', { required: true });\r\n    const runnerLabel = core.getInput('runnerLabel', { required: true });\r\n    let fullRepo = getOptionalInput('repo');\r\n    if (fullRepo === undefined) {\r\n      fullRepo = getRepository();\r\n    }\r\n    const [owner, repo] = getOwnerAndRepo(fullRepo);\r\n\r\n    core.info(`Full Repot ${fullRepo}, owner ${owner}, repo ${repo}`);\r\n\r\n    core.info(`Checking if there are any running runners with lable ${runnerLabel} which are different to run id ${currentRunId}`);\r\n\r\n\r\n    var foundRunningJob = false\r\n\r\n    // loop through all statuses to check if we have any other running jobs\r\n    var statusesToCheck: components[\"parameters\"][\"workflow-run-status\"][] = [\"requested\", \"queued\", \"in_progress\", \"pending\"];\r\n    for (const statusToCheck of statusesToCheck) {\r\n      foundRunningJob = await checkWorkflow(token, owner, repo, statusToCheck, currentRunId, runnerLabel);\r\n      if (foundRunningJob)\r\n        break;\r\n    }\r\n\r\n    // conclusion is null when run is in progress\r\n    core.info(`foundRunningJob: ${foundRunningJob}`);\r\n    core.setOutput('foundRunningJob', foundRunningJob);\r\n\r\n  } catch (ex) {\r\n    core.setFailed(`Failed with error: ${ex}`);\r\n  }\r\n}\r\n\r\nrun();\r\n"]}