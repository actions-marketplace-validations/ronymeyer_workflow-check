{"version":3,"sources":["index.ts"],"names":["core","require","rest_1","utils_1","auth_action_1","checkWorkflow","octokit","owner","repo","statusToCheck","currentRunId","runnerLabel","Promise","foundRunningJob","info","request","status","listWorkflowRunsForRepoResult","_c","sent","data","total_count","workFlowRunsFiltered","workflow_runs","filter","f","id","Number","workFlowRunsMapped","map","x","run_id","name","workFlowRunsMapped_1","_i","length","workFlowRun","rest","actions","listJobsForWorkflowRun","listJobsForWorkflowRunResult","_a","_b","jobs","labels","includes","run","getInput","required","undefined","fullRepo","getOptionalInput","getRepository","getOwnerAndRepo","createActionAuth","auth","authentication","tokenType","token","Octokit","statusesToCheck_1","setOutput","error","ensureError","ex_1","setFailed","message","value","Error","stringified","JSON","stringify"],"mappings":"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","file":"index.min.js","sourcesContent":["import * as core from '@actions/core';\r\nimport { components } from \"@octokit/openapi-types\";\r\nimport { Octokit } from '@octokit/rest';\r\nimport {\r\n  getOptionalInput,\r\n  getOwnerAndRepo,\r\n  getRepository\r\n} from './utils';\r\nimport { createActionAuth } from \"@octokit/auth-action\";\r\n\r\nasync function checkWorkflow(octokit: Octokit, owner: string, repo: string, statusToCheck: components[\"parameters\"][\"workflow-run-status\"], currentRunId: string, runnerLabel: string): Promise<boolean> {\r\n  let foundRunningJob = false;\r\n\r\n  core.info(`Start checking for status ${statusToCheck}.`);\r\n\r\n  core.info(`Using owner ${owner} and repo ${repo}.`);\r\n\r\n  const listWorkflowRunsForRepoResult = await octokit.request(\"GET /repos/{owner}/{repo}/actions/runs\", {\r\n    owner: owner,\r\n    repo: repo,\r\n    status: statusToCheck\r\n  });\r\n  /*\r\n  // this call doesn't work, it looks like owner and repo don't get replaced in the URL\r\n  octokit.rest.actions.listWorkflowRunsForRepo()\r\n  const listWorkflowRunsForRepoResult = await octokit.actions.listWorkflowRunsForRepo({\r\n    owner: owner,\r\n    repo: repo,\r\n    status: statusToCheck\r\n  });\r\n  */\r\n  core.info(`Check Runs: Received status code: ${listWorkflowRunsForRepoResult.status}, number or results: ${listWorkflowRunsForRepoResult.data.total_count}.`);\r\n\r\n  let workFlowRunsFiltered = listWorkflowRunsForRepoResult.data.workflow_runs.filter((f) => f.id != Number(currentRunId));\r\n\r\n  const workFlowRunsMapped = workFlowRunsFiltered.map((x) => ({\r\n    run_id: x.id,\r\n    name: x.name\r\n  }));\r\n\r\n  for (const workFlowRun of workFlowRunsMapped) {\r\n    core.info(`Checking for jobs with status ${statusToCheck} and runner label ${runnerLabel}.`);\r\n\r\n    if (statusToCheck == \"pending\") {\r\n      core.info(`There are pending jobs, for pending jobs there is no run_id yet, so we can't get the label.`);\r\n      foundRunningJob = true;\r\n      break;\r\n    }\r\n    const listJobsForWorkflowRunResult = await octokit.rest.actions\r\n      .listJobsForWorkflowRun({\r\n        owner,\r\n        repo,\r\n        run_id: workFlowRun.run_id\r\n      });\r\n\r\n    core.info(`Check Workflow Run ${workFlowRun.run_id} with name '${workFlowRun.name}'. Received status code: ${listJobsForWorkflowRunResult.status}, number or results: ${listJobsForWorkflowRunResult.data.total_count}.`);\r\n\r\n    for (const job of listJobsForWorkflowRunResult.data.jobs) {\r\n      if (job.labels.includes(runnerLabel)) {\r\n        foundRunningJob = true;\r\n        break;\r\n      }\r\n    }\r\n    if (foundRunningJob)\r\n      break;\r\n  }\r\n\r\n  // conclusion is null when run is in progress\r\n  core.info(`End checking for status ${statusToCheck}. foundRunningJob: ${foundRunningJob}`);\r\n\r\n  return foundRunningJob;\r\n}\r\n\r\nasync function run(): Promise<void> {\r\n  try {\r\n    //const token = core.getInput('GITHUB_TOKEN', { required: true });\r\n    const currentRunId = core.getInput('currentRunId', { required: true });\r\n    const runnerLabel = core.getInput('runnerLabel', { required: true });\r\n    let fullRepo = getOptionalInput('repo');\r\n    if (fullRepo === undefined) {\r\n      fullRepo = getRepository();\r\n    }\r\n    const [owner, repo] = getOwnerAndRepo(fullRepo);\r\n\r\n    core.info(`Checking if there are any running runners with label ${runnerLabel} which are different to run id ${currentRunId}`);\r\n\r\n    var foundRunningJob = false\r\n\r\n    const auth = createActionAuth();\r\n    const authentication = await auth();\r\n    core.info(`Auth token type ${authentication.tokenType}, token ${authentication.token.length}, owner ${owner}, repo ${repo}`);\r\n    const octokit = new Octokit({ auth: authentication.token });\r\n\r\n    // loop through all statuses to check if we have any other running jobs\r\n    var statusesToCheck: components[\"parameters\"][\"workflow-run-status\"][] = [\"pending\", \"requested\", \"queued\", \"in_progress\"];\r\n    for (const statusToCheck of statusesToCheck) {\r\n      foundRunningJob = await checkWorkflow(octokit, owner, repo, statusToCheck, currentRunId, runnerLabel);\r\n      if (foundRunningJob)\r\n        break;\r\n    }\r\n\r\n    // conclusion is null when run is in progress\r\n    core.info(`foundRunningJob: ${foundRunningJob}`);\r\n    core.setOutput('foundRunningJob', foundRunningJob);\r\n\r\n  } catch (ex) {\r\n    const error = ensureError(ex)\r\n    core.setFailed(`Failed with error: ${error.message}.`);\r\n  }\r\n}\r\n\r\nfunction ensureError(value: unknown): Error {\r\n  if (value instanceof Error) return value\r\n\r\n  let stringified = '[Unable to stringify the thrown value]'\r\n  try {\r\n    stringified = JSON.stringify(value)\r\n  } catch { }\r\n\r\n  const error = new Error(`This value was thrown as is, not through an Error: ${stringified}`)\r\n  return error\r\n}\r\n\r\nrun();\r\n"]}